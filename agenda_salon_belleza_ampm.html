
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Agenda ‚Ä¢ Sal√≥n de Belleza</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
  :root{
    --bg:#0f1117; --panel:#151a23; --line:#222a38; --ink:#e7eaf0; --muted:#9aa4b2; --accent:#6ee7b7; --accent2:#38bdf8;
    --book:#93c5fd; --busy:#fda4af; --ok:#34d399; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Helvetica Neue",sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  header{position:sticky;top:0;z-index:10;background:#0f1117cc;backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px 12px}
  .brand{font-weight:800;letter-spacing:.4px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input,button,textarea{border:1px solid var(--line);border-radius:10px;background:#0c1017;color:#fff;padding:10px 12px}
  button{cursor:pointer}
  .btn{background:linear-gradient(180deg,#1f2a3a,#16202f);border-color:#2a3547}
  .btn.accent{background:linear-gradient(180deg,#2b7a63,#1c5e4c);border-color:#2d8f76}
  .btn.blue{background:linear-gradient(180deg,#1c3a5e,#152b46);border-color:#29496f}
  .btn.red{background:linear-gradient(180deg,#5e1c2c,#461522);border-color:#6f2940}
  .btn.ghost{background:#1a2230}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;grid-template-columns:280px 1fr;gap:12px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  /* Sidebar */
  .side h3{margin:0 0 8px}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .chip{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0b1220;color:#c7d2fe;cursor:pointer}
  .chip.on{background:#0f2238;color:#a8d1ff}
  /* Calendar week grid */
  .cal{overflow:auto;border-radius:12px;border:1px solid var(--line)}
  .cal .head{display:grid;grid-template-columns:120px repeat(7,1fr);background:#0c1119;position:sticky;top:0;z-index:2}
  .cal .head div{padding:10px;border-right:1px solid var(--line);text-align:center}
  .cal .body{display:grid;grid-template-columns:120px repeat(7,1fr);}
  .cal .timecol{background:#0b1017;border-right:1px solid var(--line)}
  .slot{border-top:1px dashed #233047; height:44px; position:relative}
  .time{padding:6px 8px;border-top:1px solid var(--line);height:44px;font-size:12px;color:#a8b3c3}
  .daycol{position:relative}
  .apt{position:absolute; left:6px; right:6px; border-radius:8px; padding:6px 8px; font-size:12px; overflow:hidden; border:1px solid #2a3244}
  .apt.book{background:#152235;color:#cfe3ff}
  .apt.block{background:#2a1b1f;color:#ffd5dc;border-color:#5a2b37}
  .marker{position:absolute;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,#39e4b2,transparent);box-shadow:0 0 10px #39e4b2}
  .legend{display:flex;gap:8px;align-items:center;font-size:12px}
  .dot{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:4px;border:1px solid #2a3244}
  .dbook{background:#152235}.dblock{background:#2a1b1f}
  /* Modal */
  .modal{position:fixed;inset:0;background:#0b0f1499;backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:20}
  .modal .box{width:560px;max-width:92vw;background:#0e141e;border:1px solid var(--line);border-radius:14px;padding:12px}
  .box h3{margin:0 0 8px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  @media (max-width:600px){ .two{grid-template-columns:1fr} }
  .hint{font-size:12px;color:#9aa4b2}
  .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .stat{background:#0d131d;border:1px solid var(--line);border-radius:10px;padding:8px}
  .stat .big{font-weight:800;font-size:18px}
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="row">
      <div class="brand">üíá‚Äç‚ôÄÔ∏è Agenda ‚Ä¢ Sal√≥n (AM/PM)</div>
      <button class="btn" id="prev">‚óÄ</button>
      <button class="btn ghost" id="today">Hoy</button>
      <button class="btn" id="next">‚ñ∂</button>
      <input type="date" id="goto">
      <select id="interval">
        <option value="15">Intervalo: 15 min</option>
        <option value="20">Intervalo: 20 min</option>
        <option value="30" selected>Intervalo: 30 min</option>
        <option value="60">Intervalo: 60 min</option>
      </select>
      <select id="view">
        <option value="week" selected>Semana</option>
        <option value="day">D√≠a</option>
      </select>
    </div>
    <div class="row">
      <button class="btn blue" id="exportCSV">Exportar CSV</button>
      <button class="btn ghost" id="exportJSON">Exportar JSON</button>
      <label class="btn ghost">
        Importar <input type="file" id="importFile" accept=".json" style="display:none">
      </label>
      <button class="btn red" id="clearAll">Vaciar</button>
      <button class="btn accent" id="newApt">Nueva cita</button>
    </div>
  </div>
</header>

<div class="wrap grid">
  <!-- Sidebar -->
  <div class="side">
    <div class="card">
      <h3>Disponibilidad</h3>
      <div class="muted">Horarios de atenci√≥n (formato 24h para precisi√≥n)</div>
      <div class="kv" style="margin-top:8px">
        <label>Lun<br><input type="text" id="h0" value="08:00-17:00"></label>
        <label>Mar<br><input type="text" id="h1" value="08:00-17:00"></label>
        <label>Mi√©<br><input type="text" id="h2" value="08:00-17:00"></label>
        <label>Jue<br><input type="text" id="h3" value="08:00-17:00"></label>
        <label>Vie<br><input type="text" id="h4" value="08:00-17:00"></label>
        <label>S√°b<br><input type="text" id="h5" value=""></label>
        <label>Dom<br><input type="text" id="h6" value=""></label>
      </div>
      <div class="hint" style="margin-top:6px">Formato: HH:MM-HH:MM (deja vac√≠o para cerrado). En pantalla ver√°s AM/PM.</div>
      <div class="actions"><button class="btn" id="saveHours">Guardar horarios</button></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Servicios</h3>
      <div class="kv">
        <input id="svc1" placeholder="Ej. Corte + Secado (45 min)" value="Corte + Secado (45)">
        <input id="svc2" placeholder="Ej. Tinte (90 min)" value="Tinte (90)">
        <input id="svc3" placeholder="Ej. Manicure (30 min)" value="Manicure (30)">
        <input id="svc4" placeholder="Ej. Pedicure (45 min)" value="Pedicure (45)">
      </div>
      <div class="hint" style="margin-top:6px">Usa el n√∫mero entre par√©ntesis para duraci√≥n.</div>
      <div class="actions"><button class="btn" id="saveSvcs">Guardar</button></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Especialistas</h3>
      <div class="kv">
        <input id="sty1" placeholder="Ej. Ana" value="Ana">
        <input id="sty2" placeholder="Ej. Luisa" value="Luisa">
        <input id="sty3" placeholder="Ej. Carla" value="Carla">
        <input id="sty4" placeholder="Ej. Jos√©" value="Jos√©">
      </div>
      <div class="actions"><button class="btn" id="saveStylists">Guardar</button></div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3>Indicadores</h3>
      <div class="kpi">
        <div class="stat"><div class="big" id="kpiCount">0</div><div class="muted">Citas esta semana</div></div>
        <div class="stat"><div class="big" id="kpiUtil">0%</div><div class="muted">Ocupaci√≥n</div></div>
        <div class="stat"><div class="big" id="kpiToday">0</div><div class="muted">Citas hoy</div></div>
      </div>
      <div class="legend" style="margin-top:10px">
        <span class="dot dbook"></span> Reservas
        <span class="dot dblock" style="margin-left:12px"></span> Bloqueos
      </div>
    </div>
  </div>

  <!-- Calendar -->
  <div class="card cal">
    <div class="head" id="calHead"></div>
    <div class="body" id="calBody"></div>
  </div>
</div>

<!-- Modal crear/editar -->
<div class="modal" id="modal">
  <div class="box">
    <h3 id="modalTitle">Nueva cita</h3>
    <div class="two">
      <label>Cliente<br><input id="mClient" placeholder="Nombre del cliente"></label>
      <label>Tel√©fono<br><input id="mPhone" placeholder="+1 787 ..."></label>
    </div>
    <div class="two" style="margin-top:8px">
      <label>Servicio<br><input id="mService" list="svcList" placeholder="Ej. Corte + Secado (45)"></label>
      <label>Especialista<br><input id="mStylist" list="styList" placeholder="Ej. Ana"></label>
    </div>
    <div class="two" style="margin-top:8px">
      <label>Inicio<br><input id="mStart" type="datetime-local"></label>
      <label>Fin<br><input id="mEnd" type="datetime-local"></label>
    </div>
    <div class="two" style="margin-top:8px">
      <label>Duraci√≥n (min)<br><input id="mDur" type="number" value="45"></label>
      <label>Buffer (min)<br><input id="mBuf" type="number" value="0"></label>
    </div>
    <label style="display:block;margin-top:8px">Notas<br><textarea id="mNotes" rows="3" placeholder="Detalles, preferencias, etc."></textarea></label>
    <div class="actions">
      <button class="btn red" id="mDelete" style="display:none">Eliminar</button>
      <button class="btn ghost" id="mCancel">Cancelar</button>
      <button class="btn accent" id="mSave">Guardar</button>
    </div>
  </div>
</div>

<datalist id="svcList"></datalist>
<datalist id="styList"></datalist>

<script>
// ====== Estado (localStorage) ======
const LS = {
  appts: 'salon.appts.v1',
  hours: 'salon.hours.v1',
  svcs:  'salon.svcs.v1',
  styl:  'salon.styl.v1',
  cfg:   'salon.cfg.v1'
};

let APPTS = load(LS.appts, []);
// Horario por defecto: Lun‚ÄìVie 08:00-17:00, S√°b y Dom cerrado
let HOURS = load(LS.hours, ["08:00-17:00","08:00-17:00","08:00-17:00","08:00-17:00","08:00-17:00","",""]);
let SVCS  = load(LS.svcs,  ["Corte + Secado (45)","Tinte (90)","Manicure (30)","Pedicure (45)"]);
let STYL  = load(LS.styl,  ["Ana","Luisa","Carla","Jos√©"]);
let CFG   = load(LS.cfg,    {interval:30});

function load(k, d){ try{return JSON.parse(localStorage.getItem(k)) ?? d}catch{return d} }
function save(k, v){ localStorage.setItem(k, JSON.stringify(v)) }

// ====== Utilidades ======
const pad2 = n => String(n).padStart(2,'0');
function to12h(h, m=0){
  const ampm = h >= 12 ? 'PM' : 'AM';
  const hh = h % 12 === 0 ? 12 : h % 12;
  return hh + ":" + pad2(m) + " " + ampm;
}
const fmtDate = d => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
const fmtTime = d => to12h(d.getHours(), d.getMinutes()); // AM/PM
const parseTime = t => { const [h,m]=t.split(':').map(Number); return h*60+m; };
const fromLocal = s => new Date(s);
const toLocalInput = d => d.toISOString().slice(0,16);

function weekStart(d){ const x = new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; } // Lunes
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function minutesBetween(a,b){ return Math.round((b-a)/60000); }

function overlap(aStart,aEnd,bStart,bEnd){ return (aStart < bEnd) && (bStart < aEnd); }

// ====== UI refs ======
const head = document.getElementById('calHead');
const body = document.getElementById('calBody');
const viewSel = document.getElementById('view');
const intervalSel = document.getElementById('interval');
const dateInput = document.getElementById('goto');

// Seed inputs
intervalSel.value = String(CFG.interval||30);
document.getElementById('h0').value = HOURS[0];
document.getElementById('h1').value = HOURS[1];
document.getElementById('h2').value = HOURS[2];
document.getElementById('h3').value = HOURS[3];
document.getElementById('h4').value = HOURS[4];
document.getElementById('h5').value = HOURS[5];
document.getElementById('h6').value = HOURS[6];

SVCS.forEach(s=>{ const o=document.createElement('option'); o.value=s; document.getElementById('svcList').appendChild(o); });
STYL.forEach(s=>{ const o=document.createElement('option'); o.value=s; document.getElementById('styList').appendChild(o); });

// ====== Render ======
let anchor = new Date(); // referencia (hoy)
dateInput.value = fmtDate(anchor);

function render(){
  const view = viewSel.value;
  const start = view==='week' ? weekStart(anchor) : new Date(anchor.getFullYear(),anchor.getMonth(),anchor.getDate());
  const days = view==='week' ? 7 : 1;
  head.innerHTML = "";
  body.innerHTML = "";
  // Head
  const hrow = document.createElement('div');
  hrow.className = 'head';
  hrow.appendChild(cell(' '));
  for(let i=0;i<days;i++){
    const d = addDays(start,i);
    const label = d.toLocaleDateString('es-PR',{weekday:'short', day:'2-digit', month:'short'});
    hrow.appendChild(cell(label));
  }
  head.appendChild(hrow);

  // Time grid
  const interval = parseInt(intervalSel.value,10)||30;
  const minutes = buildMinuteMarks(start, days);
  const grid = document.createElement('div');
  grid.className='body';

  // left time column (AM/PM)
  const tcol = document.createElement('div'); tcol.className='timecol';
  minutes.forEach((m,i)=>{
    if(m.min%60===0){
      const d = document.createElement('div');
      d.className='time';
      d.textContent = to12h(Math.floor(m.min/60), 0); // etiqueta cada hora
      tcol.appendChild(d);
    } else {
      const s = document.createElement('div'); s.className='slot'; tcol.appendChild(s);
    }
  });
  grid.appendChild(tcol);

  // day columns
  for(let i=0;i<days;i++){
    const dcol = document.createElement('div'); dcol.className='daycol'; dcol.dataset.day=i;
    // background slots (click to add)
    minutes.forEach((m,idx)=>{
      const openRange = hoursForDay((start.getDay()+i)%7);
      const isOpen = openRange && (m.min >= openRange.start) && (m.min < openRange.end);
      const s = document.createElement('div'); s.className = (m.min%60===0?'time':'slot');
      if(isOpen) s.style.background = 'linear-gradient(90deg, rgba(56,189,248,.06), rgba(56,189,248,.02))';
      s.addEventListener('click', ()=>{ openModalAt(addMinutes(start,i,m.min)); });
      dcol.appendChild(s);
    });
    // appointments
    const dayDate = addDays(start,i);
    const dayAppts = APPTS.filter(a => fmtDate(new Date(a.start))===fmtDate(dayDate));
    dayAppts.forEach(a => paintAppt(dcol, a, start, i));
    // now marker (if today)
    const today = new Date(); 
    if(fmtDate(today)===fmtDate(dayDate)){ 
      const openRange=hoursForDay((start.getDay()+i)%7);
      if(openRange){
        const pos = ( (parseTime(fmtTime24(today)) - openRange.start) / (openRange.end-openRange.start) );
        const m = document.createElement('div'); m.className='marker'; m.style.top = Math.max(0,pos)*(minutes.length*44)+'px';
        dcol.appendChild(m);
      }
    }
    grid.appendChild(dcol);
  }
  body.appendChild(grid);
  updateKPIs();
}

function fmtTime24(d){ return pad2(d.getHours())+":"+pad2(d.getMinutes()); }

function cell(txt){ const d=document.createElement('div'); d.textContent=txt; return d; }

function buildMinuteMarks(start, days){
  let minStart=24*60, maxEnd=0;
  for(let i=0;i<days;i++){ const r=hoursForDay((start.getDay()+i)%7); if(!r) continue; minStart=Math.min(minStart, r.start); maxEnd=Math.max(maxEnd, r.end); }
  if(maxEnd<=minStart){ minStart=8*60; maxEnd=17*60; } // fallback 8‚Äì5
  const step = parseInt(intervalSel.value,10)||30;
  const marks=[]; for(let m=minStart; m<=maxEnd; m+= step){ marks.push({min:m}); }
  return marks;
}

function hoursForDay(jsDay){ // jsDay 0=Dom .. 6=Sab
  let idx = (jsDay+6)%7; // convert Sun=0 -> 6
  const s = HOURS[idx]; if(!s) return null;
  const [a,b] = s.split('-'); if(!a||!b) return null;
  return { start: parseTime(a), end: parseTime(b) };
}

function paintAppt(col, a, weekStartDate, offsetDay){
  const start = new Date(a.start), end = new Date(a.end);
  const r = hoursForDay((weekStartDate.getDay()+offsetDay)%7);
  if(!r) return;
  const totalMin = r.end - r.start;
  const top = ((parseTime(fmtTime24(start)) - r.start)/totalMin) * calcColHeight();
  const h = (minutesBetween(start,end)/totalMin) * calcColHeight();
  const div = document.createElement('div');
  div.className = 'apt '+(a.kind==='block'?'block':'book');
  div.style.top = Math.max(0, top)+'px';
  div.style.height = Math.max(28, h)+'px';
  div.innerHTML = a.kind==='block' ? ('Bloqueo<br><span class="muted">'+a.notes+'</span>')
             : ('<b>'+esc(a.client)+'</b> ¬∑ '+esc(a.service)+'<br><span class="muted">'+esc(a.stylist)+' ¬∑ '+fmtTime(start)+'‚Äì'+fmtTime(end)+'</span>');
  div.onclick = ()=> openModalEdit(a.id);
  col.appendChild(div);
}
function calcColHeight(){ return document.querySelectorAll('.time,.slot').length*44; }

function esc(s){ return (''+(s||'')).replace(/[&<>]/g,m=>({'&':'&amp;','<':'&gt;'}[m])) }

function addMinutes(startDate, dayOffset, minuteOfDay){
  const d = addDays(startDate, dayOffset);
  d.setHours(0,0,0,0);
  d.setMinutes(minuteOfDay);
  return d;
}

// ====== Modal ======
const modal = document.getElementById('modal');
const mClient = document.getElementById('mClient');
const mPhone  = document.getElementById('mPhone');
const mService= document.getElementById('mService');
const mStylist= document.getElementById('mStylist');
const mStart  = document.getElementById('mStart');
const mEnd    = document.getElementById('mEnd');
const mDur    = document.getElementById('mDur');
const mBuf    = document.getElementById('mBuf');
const mNotes  = document.getElementById('mNotes');
const mDelete = document.getElementById('mDelete');
let editId = null;

function openModalAt(date){
  editId = null;
  document.getElementById('modalTitle').textContent = 'Nueva cita';
  mClient.value=''; mPhone.value=''; mService.value=''; mStylist.value='';
  mStart.value = toLocal(date);
  const end = new Date(date.getTime() + (parseInt(mDur.value,10)||45)*60000);
  mEnd.value = toLocal(end);
  mNotes.value='';
  mDelete.style.display='none';
  modal.style.display='flex';
}

function openModalEdit(id){
  const a = APPTS.find(x=>x.id===id); if(!a) return;
  editId = id;
  document.getElementById('modalTitle').textContent = a.kind==='block'?'Editar bloqueo':'Editar cita';
  if(a.kind==='block'){ mClient.value=''; mPhone.value=''; mService.value=''; mStylist.value=''; }
  else{
    mClient.value=a.client||''; mPhone.value=a.phone||''; mService.value=a.service||''; mStylist.value=a.stylist||'';
  }
  mStart.value = toLocal(new Date(a.start));
  mEnd.value   = toLocal(new Date(a.end));
  mDur.value   = a.dur||45;
  mBuf.value   = a.buf||0;
  mNotes.value = a.notes||'';
  mDelete.style.display='inline-block';
  modal.style.display='flex';
}

function toLocal(d){ const off = d.getTimezoneOffset()*60000; const l = new Date(d - off); return l.toISOString().slice(0,16); }

document.getElementById('mCancel').onclick = ()=> modal.style.display='none';
document.getElementById('mSave').onclick = ()=>{
  const start = fromLocal(mStart.value);
  let end = fromLocal(mEnd.value);
  const dur = parseInt(mDur.value,10)||45;
  const buf = parseInt(mBuf.value,10)||0;
  if(!mEnd.value){ end = new Date(start.getTime() + dur*60000); }

  const isBlock = (!mClient.value && !mService.value);
  const obj = {
    id: editId || ('a'+Date.now()),
    kind: isBlock ? 'block' : 'book',
    client: mClient.value.trim(),
    phone: mPhone.value.trim(),
    service: mService.value.trim(),
    stylist: mStylist.value.trim(),
    start: start.toISOString(),
    end: end.toISOString(),
    dur: dur, buf: buf,
    notes: mNotes.value.trim()
  };

  if(conflict(obj, editId)){
    alert('Conflicto: el especialista ya est√° ocupado o el sal√≥n est√° fuera de horario.');
    return;
  }

  if(editId){
    APPTS = APPTS.map(x=> x.id===editId ? obj : x);
  }else{
    APPTS.push(obj);
  }
  save(LS.appts, APPTS);
  modal.style.display='none';
  render();
};

document.getElementById('mDelete').onclick = ()=>{
  if(editId && confirm('¬øEliminar este registro?')){
    APPTS = APPTS.filter(x=>x.id!==editId);
    save(LS.appts, APPTS);
    modal.style.display='none';
    render();
  }
};

document.getElementById('newApt').onclick = ()=> openModalAt(new Date());

function conflict(a, ignoreId=null){
  const s = new Date(a.start), e = new Date(a.end);
  const r = hoursForDay(s.getDay()); if(!r) return true;
  const mins = parseTime(fmtTime24(s));
  const mine = parseTime(fmtTime24(e));
  if(!(mins>=r.start && mine<=r.end)) return true;
  return APPTS.some(b=>{
    if(ignoreId && b.id===ignoreId) return false;
    const bs = new Date(b.start), be = new Date(b.end);
    const stylistMatch = (a.kind==='block' || b.kind==='block') ? true : ((a.stylist||'') === (b.stylist||''));
    return stylistMatch && overlap(s,e,bs,be);
  });
}

// ====== Eventos barra ======
document.getElementById('prev').onclick = ()=>{ anchor = addDays(anchor, viewSel.value==='week'?-7:-1); dateInput.value=fmtDate(anchor); render(); };
document.getElementById('next').onclick = ()=>{ anchor = addDays(anchor, viewSel.value==='week'?7:1); dateInput.value=fmtDate(anchor); render(); };
document.getElementById('today').onclick= ()=>{ anchor = new Date(); dateInput.value=fmtDate(anchor); render(); };
dateInput.onchange = ()=>{ anchor = new Date(dateInput.value+" 00:00"); render(); };
intervalSel.onchange = ()=>{ CFG.interval = parseInt(intervalSel.value,10)||30; save(LS.cfg, CFG); render(); };
viewSel.onchange = ()=> render();

// ====== Guardar configuraci√≥n lateral ======
document.getElementById('saveHours').onclick = ()=>{
  HOURS = [0,1,2,3,4,5,6].map(i => document.getElementById('h'+i).value.trim());
  save(LS.hours, HOURS);
  render();
};
document.getElementById('saveSvcs').onclick = ()=>{
  SVCS = [1,2,3,4].map(i => document.getElementById('svc'+i).value.trim()).filter(Boolean);
  save(LS.svcs, SVCS);
  const list = document.getElementById('svcList'); list.innerHTML=''; SVCS.forEach(s=>{ const o=document.createElement('option'); o.value=s; list.appendChild(o); });
  alert('Servicios guardados');
};
document.getElementById('saveStylists').onclick = ()=>{
  STYL = [1,2,3,4].map(i => document.getElementById('sty'+i).value.trim()).filter(Boolean);
  save(LS.styl, STYL);
  const list = document.getElementById('styList'); list.innerHTML=''; STYL.forEach(s=>{ const o=document.createElement('option'); o.value=s; list.appendChild(o); });
  alert('Especialistas guardados');
};

// ====== Export/Import ======
document.getElementById('exportCSV').onclick = ()=>{
  const csv = toCSV(APPTS);
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='citas_salon.csv'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),500);
};
document.getElementById('exportJSON').onclick = ()=>{
  const blob = new Blob([JSON.stringify(APPTS,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='citas_salon.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),500);
};
document.getElementById('importFile').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=ev=>{
    try{
      const arr = JSON.parse(ev.target.result);
      if(!Array.isArray(arr)) throw new Error('JSON inv√°lido');
      APPTS = merge(APPTS, arr);
      save(LS.appts, APPTS);
      render();
      alert('Importado ‚úÖ');
    }catch(err){ alert('Error al importar: '+err.message); }
  };
  rd.readAsText(f, 'UTF-8');
});
document.getElementById('clearAll').onclick = ()=>{
  if(confirm('¬øBorrar TODOS los registros y configuraci√≥n en este dispositivo?')){
    localStorage.removeItem(LS.appts);
    localStorage.removeItem(LS.hours);
    localStorage.removeItem(LS.svcs);
    localStorage.removeItem(LS.styl);
    localStorage.removeItem(LS.cfg);
    APPTS=[]; HOURS=["08:00-17:00","08:00-17:00","08:00-17:00","08:00-17:00","08:00-17:00","",""]; SVCS=["Corte + Secado (45)","Tinte (90)","Manicure (30)","Pedicure (45)"]; STYL=["Ana","Luisa","Carla","Jos√©"]; CFG={interval:30};
    render();
  }
};

function merge(cur, inc){
  const map = new Map(cur.map(x=>[x.id,x]));
  inc.forEach(x=>{ if(!map.has(x.id)) map.set(x.id,x); });
  return Array.from(map.values());
}

function toCSV(arr){
  const head = ['id','kind','client','phone','service','stylist','start','end','dur','buf','notes'];
  const lines = [head.join(',')];
  arr.forEach(x=>{
    const row = head.map(h => csvCell(x[h]));
    lines.push(row.join(','));
  });
  return lines.join('\n');
}
function csvCell(v){ if(v==null) return ''; const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?'"'+s+'"':s; }

// ====== KPIs ======
function updateKPIs(){
  const start = weekStart(anchor);
  const end = addDays(start,7);
  const inWeek = APPTS.filter(a => new Date(a.start)>=start && new Date(a.start)<end && a.kind==='book');
  document.getElementById('kpiCount').textContent = inWeek.length;
  const today = new Date(); document.getElementById('kpiToday').textContent = APPTS.filter(a => a.kind==='book' && fmtDate(new Date(a.start))===fmtDate(today)).length;
  let avail=0; for(let i=0;i<7;i++){ const r=hoursForDay((start.getDay()+i)%7); if(r) avail += (r.end - r.start); }
  let used=0; inWeek.forEach(a=>{ used += minutesBetween(new Date(a.start), new Date(a.end)); });
  const util = avail? Math.round(used/avail*100):0;
  document.getElementById('kpiUtil').textContent = util+'%';
}

// init
render();
</script>
</body>
</html>
